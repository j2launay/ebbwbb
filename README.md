# Counterfactual Explanation Methods for NLP Models (Growing Net & Growing Language)
This repository contains the code of the paper [`Does It Make Sense to Explain a Black Box With Another Black Box?'](https://arxiv.org/abs/2404.14943)

It provides code for two model-agnostic counterfactual explanation methods for NLP models: Growing Net and Growing Language. Both methods aim to identify the minimal changes required in text to alter a model's prediction. Growing Net leverages WordNet, while Growing Language utilizes Large Language Models to find similar words for text modification.

## Installation
Install required packages using pip:

```bash
pip install -r requirements.txt
```

## Code Structure
* `counterfactuals_methods.py`: Implements the `Counterfactuals` class for generating counterfactuals.
* `generate_counterfactual_experiments.py`: Code for experiments using the counterfactual methods.

## Counterfactual Generation
The `Counterfactuals` class offers methods to generate counterfactuals:

* `__init__(...)`: Initializes the class with various parameters (explained below).
* `find_counterfactual(...)`: Finds the minimal change required to alter the model's prediction and returns the closest counterfactual explanation.
* `exploration(...)`: Explores the feature space to locate the decision boundary for generating counterfactual candidates.


**Parameters for `Counterfactuals`:**
The `Counterfactuals` class takes several parameters to control the generation of counterfactuals:

* `vector_to_interprete`: The input text to be explained.
* `obs_to_interprete`: The instance whose prediction needs explanation.
* `prediction_fn`: The prediction function returning an integer label.
* `method` (str): Counterfactual method to use ("growing_language", "growing_net", "sedc", or "random").
* `target_class` (int, optional): Specific target class for counterfactual search (if None, chooses closest class in multi-class scenarios).
* `n_in_layer` (int): Number of sentences generated per round of exploration.
* `first_radius` (float): Initial radius for similarity search when finding replacement words.
* `decrease_radius` (float): Coefficient for decreasing similarity radius in subsequent searches.
* `min_counterfactual_in_sphere` (int): Minimum number of counterfactuals generated to stop the process.
* `nlp` (SpaCy model, optional): Required for GrowingLanguage method.
* `corpus` (str, optional): Input dataset used for random word selection (used by "random" method).


## Reproducing Experiments:

The `results` folder contains counterfactuals generated by each method. Code used to generate graphs for the paper is available in `generate_results.py`. The DistillBERT models used in the experiments are located in a separate repository (`model`), along with the training script (`train_bert.py`).

## License
```
BSD 3-Clause-Attribution License

Copyright (c) 2022, IMATAG and CNRS

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
   contributors may be used to endorse or promote products derived from
   this software without specific prior written permission.

4. Redistributions of any form whatsoever must retain the following acknowledgment: 
   'This product includes software developed by IMATAG and CNRS'

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
```
## Citation
Here is the bibtex if you want to cite this work:
```bibtex
@inproceedings{counterfactul_spectrum,
 author = {Julien Delaunay and Luis Galarraga and Christine Largouet},
 title = {Does It Make Sense to Explain a Black Box With Another Black Box?},
 booktitle = {Revue TAL : Explicabilité des modèles de TAL},
 year = {2024}
}